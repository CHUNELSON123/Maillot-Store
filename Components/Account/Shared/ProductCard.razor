@using MaillotStore.Models
@using MaillotStore.Services
@using MaillotStore.Components.Shared
@inject StateContainer StateContainer
@inject NavigationManager NavigationManager

<div class="product-card">
    <div class="product-image-container">
        <a href="/product/@Product.ProductId">
            <img src="@Product.ImageUrl" class="card-img-top" alt="@Product.Name">
        </a>

        <AuthorizeView Roles="Influencer">
            <button @onclick="ToggleShareModal" class="product-share-icon-button">
                <i class="fas fa-share-alt"></i>
            </button>
        </AuthorizeView>
    </div>

    <div class="card-body">
        <h5 class="card-title">@Product.Name</h5>
        <p class="card-price">@($"FCFA {Product.Price:N0} XAF")</p>
        <p class="card-season">@Product.Season</p>
        <div class="d-grid gap-2">
            <a href="/product/@Product.ProductId" class="btn btn-product-action">
                <i class="fas fa-eye me-2"></i> View Details
            </a>
            <button @onclick="() => AddToCartAndNavigate(Product)" class="btn btn-product-action">
                <i class="fas fa-cart-plus me-2"></i> Add to Cart
            </button>
        </div>
    </div>
</div>

<ShareModal Product="Product" IsVisible="isShareModalVisible" OnClose="ToggleShareModal" />


@code {
    [Parameter]
    public Product Product { get; set; } = new();

    private bool isShareModalVisible = false;

    private void ToggleShareModal()
    {
        isShareModalVisible = !isShareModalVisible;
    }

    private async Task AddToCartAndNavigate(Product product)
    {
        var defaultSize = product.Sizes?.Split(',').FirstOrDefault()?.Trim() ?? "M";
        await StateContainer.AddToCart(product, 1, defaultSize, null, null);
        NavigationManager.NavigateTo("/checkout");
    }
}