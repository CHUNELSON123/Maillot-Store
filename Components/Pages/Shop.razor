@page "/shop"
@using MaillotStore.Models
@using MaillotStore.Components.Account.Shared
@using MaillotStore.Data
@using Microsoft.EntityFrameworkCore
@rendermode InteractiveServer
@inject ApplicationDbContext DbContext

<PageTitle>Shop</PageTitle>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2>Shop</h2>
            <p>Browse our collection of authentic football jerseys.</p>
        </div>
        <div class="col-md-6 d-flex justify-content-end align-items-center">
            <div class="me-3">
                <label for="sort-by" class="form-label">Sort by:</label>
                <select class="form-select" id="sort-by">
                    <option selected>Default</option>
                    <option value="price-asc">Price: Low to High</option>
                    <option value="price-desc">Price: High to Low</option>
                </select>
            </div>
            <div>
                <label for="filter-by" class="form-label">Filter by:</label>
                <select class="form-select" id="filter-by">
                    <option selected>All</option>
                    <option value="men">Men</option>
                    <option value="women">Women</option>
                    <option value="kids">Kids</option>
                </select>
            </div>
        </div>
    </div>

    @if (pagedProducts is not null)
    {
        <div class="row g-4">
            @foreach (var product in pagedProducts)
            {
                <div class="col-6 col-lg-4">
                    @* The wrapper link has been removed *@
                    <ProductCard Product="product" />
                </div>
            }
        </div>
    }
    else
    {
        <p>Loading products...</p>
    }

    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                <a class="page-link" href="javascript:void(0)" @onclick="() => ChangePage(currentPage - 1)">Previous</a>
            </li>
            @for (int i = 1; i <= totalPages; i++)
            {
                var pageNumber = i;
                <li class="page-item @(currentPage == pageNumber ? "active" : "")">
                    <a class="page-link" href="javascript:void(0)" @onclick="() => ChangePage(pageNumber)">@pageNumber</a>
                </li>
            }
            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                <a class="page-link" href="javascript:void(0)" @onclick="() => ChangePage(currentPage + 1)">Next</a>
            </li>
        </ul>
    </nav>
</div>

@code {
    private List<Product>? allProducts;
    private List<Product>? pagedProducts;
    private int currentPage = 1;
    private int pageSize = 12;
    private int totalPages;

    protected override async Task OnInitializedAsync()
    {
        allProducts = await DbContext.Products.ToListAsync();
        if (allProducts is not null)
        {
            totalPages = (int)Math.Ceiling(allProducts.Count / (double)pageSize);
            UpdatePagedProducts();
        }
    }

    private void ChangePage(int pageNumber)
    {
        if (pageNumber >= 1 && pageNumber <= totalPages)
        {
            currentPage = pageNumber;
            UpdatePagedProducts();
        }
    }

    private void UpdatePagedProducts()
    {
        if (allProducts is not null)
        {
            pagedProducts = allProducts.Skip((currentPage - 1) * pageSize).Take(pageSize).ToList();
        }
    }
}