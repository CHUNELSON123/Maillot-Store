@using MaillotStore.Models
@inject NavigationManager NavigationManager
@inject IJSRuntime JSRuntime

@if (IsVisible && Product is not null)
{
    <div class="share-modal-overlay" @onclick="CloseModal">
        <div class="share-modal-content" @onclick:stopPropagation="true">
            <h4>Share "@Product.Name"</h4>
            <div class="share-options">
                <a href="@GetFacebookShareLink()" target="_blank" class="share-icon facebook">
                    <i class="fab fa-facebook-f"></i>
                </a>
                <a href="@GetWhatsAppShareLink()" target="_blank" class="share-icon whatsapp">
                    <i class="fab fa-whatsapp"></i>
                </a>
                <a @onclick="CopyLinkForMobile" class="share-icon instagram">
                    <i class="fab fa-instagram"></i>
                </a>
                <a @onclick="CopyLinkForMobile" class="share-icon tiktok">
                    <i class="fab fa-tiktok"></i>
                </a>
            </div>
            @if (showCopyMessage)
            {
                <p class="copy-message">Link copied! Paste it in your story.</p>
            }
        </div>
    </div>
}

@code {
    [Parameter]
    public Product? Product { get; set; }

    [Parameter]
    public bool IsVisible { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private bool showCopyMessage = false;

    private Task CloseModal()
    {
        showCopyMessage = false;
        return OnClose.InvokeAsync();
    }

    private string GetProductUrl()
    {
        return NavigationManager.ToAbsoluteUri($"/product/{Product?.ProductId}").ToString();
    }

    private string GetFacebookShareLink()
    {
        // Facebook's scraper will fetch the image and title from your product page.
        // Sharing to stories is a mobile-app-only feature, so this creates a standard post.
        return $"https://www.facebook.com/sharer/sharer.php?u={Uri.EscapeDataString(GetProductUrl())}";
    }

    private string GetWhatsAppShareLink()
    {
        var message = $"Check out this product: {GetProductUrl()}";
        return $"https://api.whatsapp.com/send?text={Uri.EscapeDataString(message)}";
    }

    private async Task CopyLinkForMobile()
    {
        // For Instagram & TikTok, the best user experience is to copy the link.
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", GetProductUrl());
        showCopyMessage = true;
    }
}